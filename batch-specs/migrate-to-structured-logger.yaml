name: migrate-to-structured-logger
description: |
  ## Complex Rewrite: Migrate console.* to Structured Logger

  This batch change demonstrates **AST-level code transformation** using comby,
  not simple string replacement. It migrates scattered `console.log`, `console.error`,
  and `console.warn` calls to a structured logging format.

  ### Why This Is Complex

  This transformation requires understanding code structure because:
  1. Variable interpolation must be extracted into metadata objects
  2. String concatenation must be converted to template + metadata
  3. `console.log` â†’ `logger.info` (method name change)
  4. Multiple arguments must be restructured into `{ key: value }` format
  5. Logger import must be added to files

  ### Before
  ```typescript
  console.log('Fetching episodes, id:', id);
  console.error('Failed to fetch:', error.message);
  ```

  ### After
  ```typescript
  import { logger } from '@podcast-index/shared-ui';

  logger.info('Fetching episodes', { id });
  logger.error('Failed to fetch', { error: error.message });
  ```

on:
  - repositoriesMatchingQuery: file:\.tsx?$ repo:sourcegraph-community/batch-changes-demo

steps:
  # Step 1: Transform console.log with single string message
  - run: |
      comby -in-place "console.log(':[msg]')" "logger.info(':[msg]')" .ts .tsx -matcher .ts
    container: comby/comby

  # Step 2: Transform console.log with message and single variable (colon separator)
  - run: |
      comby -in-place "console.log(':[msg]:', :[var])" "logger.info(':[msg]', { :[var] })" .ts .tsx -matcher .ts
    container: comby/comby

  # Step 3: Transform console.log with message and single variable (comma separator)
  - run: |
      comby -in-place "console.log(':[msg]', :[var])" "logger.info(':[msg]', { value: :[var] })" .ts .tsx -matcher .ts
    container: comby/comby

  # Step 4: Transform console.error with message and variable
  - run: |
      comby -in-place "console.error(':[msg]:', :[var])" "logger.error(':[msg]', { :[var] })" .ts .tsx -matcher .ts
    container: comby/comby

  # Step 5: Transform console.error with single message
  - run: |
      comby -in-place "console.error(':[msg]')" "logger.error(':[msg]')" .ts .tsx -matcher .ts
    container: comby/comby

  # Step 6: Transform console.warn with message and variable
  - run: |
      comby -in-place "console.warn(':[msg]:', :[var])" "logger.warn(':[msg]', { :[var] })" .ts .tsx -matcher .ts
    container: comby/comby

  # Step 7: Transform console.warn with single message
  - run: |
      comby -in-place "console.warn(':[msg]')" "logger.warn(':[msg]')" .ts .tsx -matcher .ts
    container: comby/comby

  # Step 8: Add logger import to files that now use logger but don't have the import
  # This uses a shell script since import management is more complex
  - run: |
      for file in $(grep -rl "logger\." --include="*.ts" --include="*.tsx" . 2>/dev/null); do
        if ! grep -q "import.*logger.*from" "$file" && ! grep -q "from './logger'" "$file"; then
          # Check if file has 'use server' directive
          if grep -q "'use server'" "$file"; then
            sed -i "s/'use server';/'use server';\n\nimport { logger } from '@podcast-index\/shared-ui';/" "$file"
          elif grep -q "import" "$file"; then
            # Add import after first import statement
            sed -i '0,/^import/s/^import/import { logger } from "@podcast-index\/shared-ui";\nimport/' "$file"
          else
            # Add import at beginning
            sed -i '1s/^/import { logger } from "@podcast-index\/shared-ui";\n\n/' "$file"
          fi
        fi
      done
    container: alpine:3.19

changesetTemplate:
  title: "refactor: migrate console.* to structured logger"
  body: |
    ## Summary
    This PR migrates scattered `console.log`, `console.error`, and `console.warn` calls
    to use the structured `logger` utility from `@podcast-index/shared-ui`.

    ### Why Structured Logging?
    - **Consistent format**: All logs follow the same structure
    - **Metadata support**: Variables are captured as searchable metadata
    - **Log levels**: Proper `info`, `warn`, `error` categorization
    - **Production ready**: Easy to integrate with log aggregation services

    ### Transformation Examples

    | Before | After |
    |--------|-------|
    | `console.log('msg:', var)` | `logger.info('msg', { var })` |
    | `console.error('failed:', err)` | `logger.error('failed', { err })` |
    | `console.warn('warning')` | `logger.warn('warning')` |

    ### Files Changed
    - API route handlers
    - Server actions
    - Data access layer

    ### Test Plan
    - [ ] Verify application starts without errors
    - [ ] Check that logs appear in expected format
    - [ ] Confirm no remaining `console.log/error/warn` calls (except in logger.ts)

    ---
    *Generated by Sourcegraph Batch Changes using comby for AST-level transformations*
  branch: refactor/structured-logging
  commit:
    message: |
      refactor: migrate console.* to structured logger

      Replace scattered console.log/error/warn calls with structured logger
      that outputs consistent JSON-formatted logs with metadata.

      This transformation was performed using comby for AST-aware code changes.
  published: false
